(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();let m={};const A={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};function D(){const e=L.map("map",{center:[20,0],zoom:2.4,minZoom:2.4,zoomSnap:.2,zoomDelta:.2,worldCopyJump:!1,maxBoundsViscosity:1,maxBounds:[[-90,-180],[90,180]]});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e),fetch("/RaceGuessr/illu_modern_points.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{pointToLayer:(o,s)=>{const n=o.properties.Region||"default",r=L.circleMarker(s,{radius:6,fillColor:A[n]||A.default,color:"#000",weight:1,opacity:1,fillOpacity:.9});return m[o.properties.Population]=r,r},onEachFeature:(o,s)=>{const n=o.properties.Population,r=o.properties.Region;s.bindTooltip(`<strong>${n}</strong><br>Region: ${r}`,{direction:"top",sticky:!0,className:"custom-tooltip"});const i=()=>{typeof window.submitGuess=="function"&&window.submitGuess(n)};s.on("click",i),s.on("touchend",c=>{c.originalEvent.preventDefault(),i()})}}).addTo(e)})}function U(){Object.keys(m).forEach(e=>{var o;m[e].setStyle({radius:6,fillColor:A[(o=m[e].feature)==null?void 0:o.properties.Region]||A.default});const t=m[e].getElement();t&&t.classList.remove("blink")})}const T={default:["European","MENA","WACA","EASEA","Siberian","American","SAO","SSA"],European:["MENA","WACA","Siberian"],MENA:["European","WACA","SAO","SSA"],WACA:["European","MENA","EASEA","Siberian","SAO"],EASEA:["WACA","Siberian","SAO"],Siberian:["European","WACA","EASEA","American"],American:["Siberian"],SAO:["MENA","WACA","EASEA","SSA"],SSA:["MENA","SAO"]},V=[100,80,70,60,50,44,38,32,26,20],J=[[1],[2,3,4],[5,6,7],[8]],Y=[12,15,18,20,24,30,40,45],$=60;function K(e,t){return Math.sqrt(e.reduce((o,s,n)=>o+(s-t[n])**2,0))}let x=0,k=!1,M=!1;function B(){k=!1,M=!0}function w(e){k=e}function j(){return k}function z(e){M=e}function X(){return M}function Z(e){x+=e}function O(){x=0}let y=[],Q=Array.from({length:25},(e,t)=>`PC${t+1}`),R=[],C={vector:null,results:null,mix:null,regions:null};async function H(){y=(await(await fetch("/RaceGuessr/illu_modern_points.geojson")).json()).features.map(s=>({name:s.properties.Population,region:s.properties.Region,coords:s.geometry.coordinates,vector:Q.map(n=>s.properties[n])})),R=y.map(s=>s.name)}async function ee(e,t=[]){y.length||await H();const o=F(e,t),s=y.filter(l=>o.includes(l.region)),n=Math.floor(Math.random()*3)+2,r=N(s,n);let i;do i=N(Y,n,!0);while(i.reduce((l,a)=>l+a,0)!==$);const c=i.map(l=>l/$),u=oe(r.map(l=>l.vector),c),d=y.map(l=>({name:l.name,distance:100*K(l.vector,u)})).sort((l,a)=>l.distance-a.distance);return C={vector:u,results:d,mix:Object.fromEntries(r.map((l,a)=>[l.name,c[a]])),regions:o},{mix_description:C.mix,regions:o,populations:r.map(l=>l.name)}}function te(e){const{results:t,vector:o,mix:s,regions:n}=C;if(!t)throw new Error("Round not initialized");const r=t.slice(0,10),i=r.map(a=>a.name),c=t.find(a=>a.name===e),u=t.findIndex(a=>a.name===e)+1,d=(c==null?void 0:c.distance)??null;let l;return i.includes(e)?l=V[i.indexOf(e)]:l=ne(e,t),Z(l),{score:l,rank:u,distance:d,guess:e,top10:r,true_mix:s,regions:n}}function F(e,t=[]){if(e==="6")return t;if(e==="5"){const c=(Math.floor(Math.random()*4)+1).toString();return F(c)}const o=J[parseInt(e)-1],s=o[Math.floor(Math.random()*o.length)],n=T.default,r=n[Math.floor(Math.random()*n.length)],i=new Set([r]);for(;i.size<s;){const c=new Set;for(const l of i){const a=T[l]||[];for(const E of a)i.has(E)||c.add(E)}const u=Array.from(c);if(u.length===0)break;const d=u[Math.floor(Math.random()*u.length)];i.add(d)}return Array.from(i)}function ne(e,t){const o=t.find(r=>r.name===e);if(!o)return 0;const s=t.findIndex(r=>r.name===e),n=o.distance;if(s>=10&&s<20){const r=t[19].distance,i=t[10].distance;return Math.round(10+(r-n)/(r-i+1e-8)*10)}else if(s>=20&&s<50){const r=t[49].distance,i=t[20].distance;return Math.round((r-n)/(r-i+1e-8)*10)}return 0}function oe(e,t){const o=e[0].length,s=Array(o).fill(0);for(let n=0;n<o;n++)for(let r=0;r<e.length;r++)s[n]+=e[r][n]*t[r];return s}function N(e,t,o=!1){return o?Array.from({length:t},()=>e[Math.floor(Math.random()*e.length)]):[...e].sort(()=>.5-Math.random()).slice(0,t)}const se={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};async function I(){const e=document.getElementById("regionSelect").value;let t=[];if(e==="6"&&(t=Array.from(document.querySelectorAll("#customRegions input:checked")).map(o=>o.value),t.length===0)){alert("Please select at least one region.");return}try{const o=await ee(e,t);le(o,se),S(),B(),z(!0),Object.entries(o.mix_description).forEach(([s])=>{m[s]&&m[s].setStyle({fillColor:"gold",radius:10})})}catch(o){console.error("startNewRound failed:",o),alert("Failed to generate new round.")}}function W(e){try{const t=te(e);w(!0),z(!1),ce(t,m)}catch(t){console.error("submitGuess failed:",t),alert("Error scoring your guess.")}}let f=null,p=0,g=0;function re(){document.getElementById("regionSelect").addEventListener("change",ie)}function ie(){const e=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=e==="6"?"block":"none"}function S(){document.getElementById("resultBox").style.display="none",document.getElementById("submitBtn").style.display="block",document.getElementById("submitBtn").disabled=!1,document.getElementById("guessInput").disabled=!1,document.getElementById("guessBox").style.display="block",document.getElementById("guessInput").value="",U()}function le(e,t){const o=document.getElementById("mixDescription"),s=Object.entries(e.mix_description).map(([n,r])=>`${n}: ${Math.round(r*100)}%`);if(e.regions&&Array.isArray(e.regions)){const n=e.regions.map(r=>`<span style="color:${t[r]||t.default}; font-weight:500; font-size:0.8em;">${r}</span>`);s.unshift(`<em>${n.join(" ")}</em>`)}o.innerHTML=s.join("<br>")}function ce(e){var o;document.getElementById("submitBtn").style.display="none",document.getElementById("submitBtn").disabled=!0,document.getElementById("guessInput").disabled=!0,document.getElementById("score").innerText=x;const t=document.querySelector("#resultTable tbody");if(t.innerHTML="",e.top10.forEach((s,n)=>{var c,u;const r=P(s.distance),i=document.createElement("tr");if(e.rank===n+1?i.innerHTML=`
        <td><strong>${n+1}. ${e.guess}</strong><br>(${e.score} points!)</td>
        <td style="color:${r}"><strong>${((c=e.distance)==null?void 0:c.toFixed(4))??"?"}</strong></td>
      </tr>`:i.innerHTML=`
        <td>${n+1}. ${s.name}</td>
        <td style="color:${r}">${s.distance.toFixed(4)}</td>
      </tr>`,t.appendChild(i),n<5&&m[s.name]){const d=[10,9,8,7,6][n];m[s.name].setStyle({fillColor:"lime",radius:d}),(u=m[s.name].getElement())==null||u.classList.add("blink")}}),e.rank>10){const s=P(e.distance),n=document.createElement("tr");n.innerHTML=`
      <td><strong>${e.rank}. ${e.guess}</strong><br>(${e.score} points!)</td>
      <td style="color:${s}"><strong>${((o=e.distance)==null?void 0:o.toFixed(4))??"?"}</strong></td>
    </tr>`,t.appendChild(n)}document.getElementById("resultBox").style.display="block",f==="compete"&&(g+=e.score,document.getElementById("score").textContent=g,p===10?(_(g),f=null,p=0,g=0,b(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none"):document.getElementById("nextRoundBtn").disabled=!1)}function de(){const e=document.getElementById("popSuggestions");e.innerHTML="",R.forEach(t=>{const o=document.createElement("option");o.value=t,e.appendChild(o)})}function ae(){document.getElementById("regionSelect").disabled=!0,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!0})}function b(){document.getElementById("regionSelect").disabled=!1,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!1})}function ue(){const e=document.getElementById("practiceBtn"),t=document.getElementById("competeBtn"),o=document.getElementById("nextRoundBtn"),s=document.getElementById("quitBtn");e==null||e.addEventListener("click",()=>{f="practice",b(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",B(),S(),document.getElementById("score").textContent=x,I()}),t==null||t.addEventListener("click",()=>{f="compete",p=1,g=0,w(!1),ae(),document.getElementById("modeButtons").style.display="none",document.getElementById("competeControls").style.display="block",document.getElementById("roundCounter").textContent=`Round: ${p} / 10`,B(),S(),document.getElementById("score").textContent="0",document.getElementById("nextRoundBtn").disabled=!0,I()}),o==null||o.addEventListener("click",()=>{j()&&(p++,p>10?(_(g),f=null,p=0,g=0,O(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",b()):(w(!1),B(),S(),document.getElementById("roundCounter").textContent=`Round: ${p} / 10`,document.getElementById("nextRoundBtn").disabled=!0,I()))}),s==null||s.addEventListener("click",()=>{f=null,p=0,g=0,O(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",b()})}function me(e){return{1:"Single",2:"Multiple",3:"Majority",4:"Global",5:"Random",6:"Custom"}[e]||"Unknown"}function pe(){return Array.from(document.querySelectorAll("#customRegions input[type=checkbox]:checked")).map(e=>({name:e.value,color:e.style.color||"black"}))}function _(e){const t=document.getElementById("regionSelect").value,o=me(t),s=document.getElementById("finalResultPopup"),n=document.getElementById("finalResultText"),r=document.getElementById("finalResultSubtext");if(n.innerText=`You scored ${e} points!`,t==="6"){const i=pe();i.length===0?r.innerText="(No custom regions selected)":r.innerHTML=i.map(c=>`<span style="color:${c.color}; font-weight:bold;">${c.name}</span>`).join(" ")}else r.innerText=`${o} Mode`;s.style.display="block"}function P(e){return e<1?"lime":e<3?"green":e<5?"orange":e<6?"red":"darkblue"}window.addEventListener("DOMContentLoaded",async()=>{var n,r,i,c,u;await H(),de(),D(),re(),ue();const e=document.getElementById("howToPlayPopup");!localStorage.getItem("seenIntro")&&e&&(e.style.display="flex",setTimeout(()=>e.classList.add("visible"),10),(n=document.getElementById("popupCloseBtn"))==null||n.addEventListener("click",()=>{e.style.display="none",localStorage.setItem("seenIntro","true")}));function o(){const d=h=>h.toLowerCase().replace(/\s+/g,""),l={};R.forEach(h=>{const q=h.toLowerCase().replace(/[-_]/g,"");l[q]=h});const a=document.getElementById("guessInput").value.trim(),E=d(a),v=l[E];if(!v){alert("That population does not exist. Please try again.");return}W(v)}const s=document.getElementById("guessInput");s==null||s.addEventListener("keypress",d=>{d.key==="Enter"&&o()}),(r=document.getElementById("submitBtn"))==null||r.addEventListener("click",o),(i=document.getElementById("regionSelect"))==null||i.addEventListener("change",()=>{const d=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=d==="6"?"block":"none"}),(c=document.querySelectorAll("#customRegions input"))==null||c.forEach(d=>{d.addEventListener("click",l=>l.stopPropagation())}),(u=document.getElementById("newRoundBtn"))==null||u.addEventListener("click",()=>{I(),setTimeout(()=>{var d;(d=document.getElementById("guessInput"))==null||d.focus()},50)})});window.submitGuess=e=>{if(X()){if(j()){alert("You already guessed this round!");return}W(e)}};window.showPopupPage=function(e){for(let t=1;t<=3;t++){const o=document.getElementById(`popupPage${t}`);o&&(o.style.display=t===e?"block":"none",t===e&&o.classList.add("slide-in"))}};function ge(){const e=document.getElementById("howToPlayPopup");e.style.display="flex",setTimeout(()=>e.classList.add("visible"),10)}ge();var G;(G=document.getElementById("popupCloseBtn"))==null||G.addEventListener("click",()=>{document.getElementById("howToPlayPopup").style.display="none"});
