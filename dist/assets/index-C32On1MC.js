(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();let d={};const p={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};function x(){const e=L.map("map").setView([30,20],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e),fetch("/ne_110m_land.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{style:{color:"#999",weight:1,fillColor:"#ddd",fillOpacity:.6}}).addTo(e)}),fetch("/illu_modern_points.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{pointToLayer:(o,i)=>{const r=o.properties.Region||"default",n=L.circleMarker(i,{radius:5,fillColor:p[r]||p.default,color:"#000",weight:1,opacity:1,fillOpacity:.9});return d[o.properties.Population]=n,n},onEachFeature:(o,i)=>{const r=o.properties.Population,n=o.properties.Region;i.bindTooltip(`<strong>${r}</strong><br>Region: ${n}`),i.on("click",()=>{typeof window.submitGuess=="function"&&window.submitGuess(r)})}}).addTo(e)})}function C(){Object.keys(d).forEach(e=>{var o;d[e].setStyle({radius:5,fillColor:p[(o=d[e].feature)==null?void 0:o.properties.Region]||p.default});const t=d[e].getElement();t&&t.classList.remove("blink")})}let I=0,y=!1,E=!1;function v(){y=!1,E=!0}function R(e){y=e}function M(){return y}function B(e){E=e}function k(){return E}function N(e){I+=e}function T(){document.getElementById("regionSelect").addEventListener("change",$)}function $(){const e=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=e==="6"?"block":"none"}function P(){document.getElementById("resultBox").style.display="none",document.getElementById("submitBtn").style.display="block",document.getElementById("submitBtn").disabled=!1,document.getElementById("guessInput").disabled=!1,document.getElementById("guessBox").style.display="block",document.getElementById("guessInput").value="",C()}function j(e,t){const o=document.getElementById("mixDescription"),i=Object.entries(e.mix_description).map(([r,n])=>`${r}: ${Math.round(n*100)}%`);if(e.regions&&Array.isArray(e.regions)){const r=e.regions.map(n=>`<span style="color:${t[n]||t.default}; font-weight:500; font-size:0.8em;">${n}</span>`);i.unshift(`<em>${r.join(" ")}</em>`)}o.innerHTML=i.join("<br>")}function G(e){var o;document.getElementById("submitBtn").style.display="none",document.getElementById("submitBtn").disabled=!0,document.getElementById("guessInput").disabled=!0,document.getElementById("score").innerText=I;const t=document.querySelector("#resultTable tbody");t.innerHTML="",e.top10.forEach((i,r)=>{var s;const n=document.createElement("tr");n.innerHTML=`<td>${r+1}. ${i.name}</td><td>${i.distance.toFixed(4)}</td>`,t.appendChild(n),r<3&&d[i.Population]&&(d[i.Population].setStyle({fillColor:"lime"}),(s=d[i.Population].getElement())==null||s.classList.add("blink"))}),document.getElementById("resultMessage").innerHTML=`<div style="font-size: 0.8em;"><em>Your Guess:</em> ${e.rank}. ${e.guess} (${e.score} points!) ${((o=e.distance)==null?void 0:o.toFixed(4))??"?"}</div>`,document.getElementById("resultBox").style.display="block"}const A={default:["European","MENA","WACA","EASEA","Siberian","American","SAO","SSA"],European:["MENA","WACA","Siberian"],MENA:["European","WACA","SAO","SSA"],WACA:["European","MENA","EASEA","Siberian","SAO"],EASEA:["WACA","Siberian","SAO"],Siberian:["European","WACA","EASEA","American"],American:["Siberian"],SAO:["MENA","WACA","EASEA","SSA"],SSA:["MENA","SAO"]},_=[100,80,70,60,50,44,38,32,26,20],W=[[1],[2,3,4],[5,6,7],[8]],F=[12,15,18,20,24,30,40,45],S=60;function H(e,t){return Math.sqrt(e.reduce((o,i,r)=>o+(i-t[r])**2,0))}let f=[],z=Array.from({length:25},(e,t)=>`PC${t+1}`),g={vector:null,results:null,mix:null,regions:null};async function q(){f=(await(await fetch("/illu_modern_points.geojson")).json()).features.map(o=>({name:o.properties.Population,region:o.properties.Region,coords:o.geometry.coordinates,vector:z.map(i=>o.properties[i])}))}async function D(e,t=[]){f.length||await q();const o=w(e,t),i=f.filter(a=>o.includes(a.region)),r=Math.floor(Math.random()*3)+2,n=b(i,r);let s;do s=b(F,r,!0);while(s.reduce((a,l)=>a+l,0)!==S);const c=s.map(a=>a/S),u=Y(n.map(a=>a.vector),c),m=f.map(a=>({name:a.name,distance:100*H(a.vector,u)})).sort((a,l)=>a.distance-l.distance);return g={vector:u,results:m,mix:Object.fromEntries(n.map((a,l)=>[a.name,c[l]])),regions:o},{mix_description:g.mix,regions:o,populations:n.map(a=>a.name)}}function J(e){const{results:t,vector:o,mix:i,regions:r}=g;if(!t)throw new Error("Round not initialized");const n=t.slice(0,10),s=n.map(l=>l.name),c=t.find(l=>l.name===e),u=t.findIndex(l=>l.name===e)+1,m=(c==null?void 0:c.distance)??null;let a;return s.includes(e)?a=_[s.indexOf(e)]:a=U(e,o),N(a),{score:a,rank:u,distance:m,guess:e,top10:n,true_mix:i,regions:r}}function w(e,t=[]){if(e==="6")return t;if(e==="5"){const c=(Math.floor(Math.random()*4)+1).toString();return w(c)}const o=W[parseInt(e)-1],i=o[Math.floor(Math.random()*o.length)],r=A.default,n=r[Math.floor(Math.random()*r.length)],s=new Set([n]);for(;s.size<i;){const c=new Set;for(const a of s){const l=A[a]||[];for(const h of l)s.has(h)||c.add(h)}const u=Array.from(c);if(u.length===0)break;const m=u[Math.floor(Math.random()*u.length)];s.add(m)}return Array.from(s)}function U(e,t){const o=t.find(n=>n.name===e);if(!o)return 0;const i=t.findIndex(n=>n.name===e),r=o.distance;if(i>=10&&i<20){const n=t[19].distance,s=t[10].distance;return Math.round(10+(n-r)/(n-s+1e-8)*10)}else if(i>=20&&i<50){const n=t[49].distance,s=t[20].distance;return Math.round((n-r)/(n-s+1e-8)*10)}return 0}function Y(e,t){const o=e[0].length,i=Array(o).fill(0);for(let r=0;r<o;r++)for(let n=0;n<e.length;n++)i[r]+=e[n][r]*t[n];return i}function b(e,t,o=!1){return o?Array.from({length:t},()=>e[Math.floor(Math.random()*e.length)]):[...e].sort(()=>.5-Math.random()).slice(0,t)}const V={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};async function K(){const e=document.getElementById("regionSelect").value;let t=[];if(e==="6"&&(t=Array.from(document.querySelectorAll("#customRegions input:checked")).map(o=>o.value),t.length===0)){alert("Please select at least one region.");return}try{const o=await D(e,t);j(o,V),P(),v(),B(!0),Object.entries(o.mix_description).forEach(([i])=>{d[i]&&d[i].setStyle({fillColor:"gold",radius:9})})}catch(o){console.error("startNewRound failed:",o),alert("Failed to generate new round.")}}function O(e){try{const t=J(e);R(!0),B(!1),G(t,d)}catch(t){console.error("submitGuess failed:",t),alert("Error scoring your guess.")}}window.addEventListener("DOMContentLoaded",()=>{var o,i,r,n;x(),T();function e(){if(M()){alert("You already guessed this round!");return}const s=document.getElementById("guessInput").value.trim();s!==""&&O(s)}const t=document.getElementById("guessInput");t==null||t.addEventListener("keypress",s=>{s.key==="Enter"&&e()}),(o=document.getElementById("submitBtn"))==null||o.addEventListener("click",e),(i=document.getElementById("regionSelect"))==null||i.addEventListener("change",()=>{const s=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=s==="6"?"block":"none"}),(r=document.querySelectorAll("#customRegions input"))==null||r.forEach(s=>{s.addEventListener("click",c=>c.stopPropagation())}),(n=document.getElementById("newRoundBtn"))==null||n.addEventListener("click",()=>{K(),setTimeout(()=>{var s;(s=document.getElementById("guessInput"))==null||s.focus()},50)})});window.submitGuess=e=>{if(k()){if(M()){alert("You already guessed this round!");return}O(e)}};
