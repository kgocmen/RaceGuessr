(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();let d={};const p={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};function v(){const e=L.map("map").setView([30,20],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e),fetch("/RaceGuessr/ne_110m_land.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{style:{color:"#999",weight:1,fillColor:"#ddd",fillOpacity:.6}}).addTo(e)}),fetch("/RaceGuessr/illu_modern_points.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{pointToLayer:(r,s)=>{const n=r.properties.Region||"default",o=L.circleMarker(s,{radius:5,fillColor:p[n]||p.default,color:"#000",weight:1,opacity:1,fillOpacity:.9});return d[r.properties.Population]=o,o},onEachFeature:(r,s)=>{const n=r.properties.Population,o=r.properties.Region;s.bindTooltip(`<strong>${n}</strong><br>Region: ${o}`),s.on("click",()=>{typeof window.submitGuess=="function"&&window.submitGuess(n)})}}).addTo(e)})}function x(){Object.keys(d).forEach(e=>{var r;d[e].setStyle({radius:5,fillColor:p[(r=d[e].feature)==null?void 0:r.properties.Region]||p.default});const t=d[e].getElement();t&&t.classList.remove("blink")})}let I=0,y=!1,E=!1;function k(){y=!1,E=!0}function N(e){y=e}function M(){return y}function B(e){E=e}function T(){return E}function $(e){I+=e}const A={default:["European","MENA","WACA","EASEA","Siberian","American","SAO","SSA"],European:["MENA","WACA","Siberian"],MENA:["European","WACA","SAO","SSA"],WACA:["European","MENA","EASEA","Siberian","SAO"],EASEA:["WACA","Siberian","SAO"],Siberian:["European","WACA","EASEA","American"],American:["Siberian"],SAO:["MENA","WACA","EASEA","SSA"],SSA:["MENA","SAO"]},G=[100,80,70,60,50,44,38,32,26,20],j=[[1],[2,3,4],[5,6,7],[8]],P=[12,15,18,20,24,30,40,45],S=60;function _(e,t){return Math.sqrt(e.reduce((r,s,n)=>r+(s-t[n])**2,0))}let f=[],W=Array.from({length:25},(e,t)=>`PC${t+1}`),w=[],g={vector:null,results:null,mix:null,regions:null};async function O(){f=(await(await fetch("/RaceGuessr/illu_modern_points.geojson")).json()).features.map(s=>({name:s.properties.Population,region:s.properties.Region,coords:s.geometry.coordinates,vector:W.map(n=>s.properties[n])})),w=f.map(s=>s.name)}async function F(e,t=[]){f.length||await O();const r=R(e,t),s=f.filter(a=>r.includes(a.region)),n=Math.floor(Math.random()*3)+2,o=b(s,n);let i;do i=b(P,n,!0);while(i.reduce((a,l)=>a+l,0)!==S);const c=i.map(a=>a/S),u=q(o.map(a=>a.vector),c),m=f.map(a=>({name:a.name,distance:100*_(a.vector,u)})).sort((a,l)=>a.distance-l.distance);return g={vector:u,results:m,mix:Object.fromEntries(o.map((a,l)=>[a.name,c[l]])),regions:r},{mix_description:g.mix,regions:r,populations:o.map(a=>a.name)}}function H(e){const{results:t,vector:r,mix:s,regions:n}=g;if(!t)throw new Error("Round not initialized");const o=t.slice(0,10),i=o.map(l=>l.name),c=t.find(l=>l.name===e),u=t.findIndex(l=>l.name===e)+1,m=(c==null?void 0:c.distance)??null;let a;return i.includes(e)?a=G[i.indexOf(e)]:a=z(e,r),$(a),{score:a,rank:u,distance:m,guess:e,top10:o,true_mix:s,regions:n}}function R(e,t=[]){if(e==="6")return t;if(e==="5"){const c=(Math.floor(Math.random()*4)+1).toString();return R(c)}const r=j[parseInt(e)-1],s=r[Math.floor(Math.random()*r.length)],n=A.default,o=n[Math.floor(Math.random()*n.length)],i=new Set([o]);for(;i.size<s;){const c=new Set;for(const a of i){const l=A[a]||[];for(const h of l)i.has(h)||c.add(h)}const u=Array.from(c);if(u.length===0)break;const m=u[Math.floor(Math.random()*u.length)];i.add(m)}return Array.from(i)}function z(e,t){const r=t.find(o=>o.name===e);if(!r)return 0;const s=t.findIndex(o=>o.name===e),n=r.distance;if(s>=10&&s<20){const o=t[19].distance,i=t[10].distance;return Math.round(10+(o-n)/(o-i+1e-8)*10)}else if(s>=20&&s<50){const o=t[49].distance,i=t[20].distance;return Math.round((o-n)/(o-i+1e-8)*10)}return 0}function q(e,t){const r=e[0].length,s=Array(r).fill(0);for(let n=0;n<r;n++)for(let o=0;o<e.length;o++)s[n]+=e[o][n]*t[o];return s}function b(e,t,r=!1){return r?Array.from({length:t},()=>e[Math.floor(Math.random()*e.length)]):[...e].sort(()=>.5-Math.random()).slice(0,t)}function D(){document.getElementById("regionSelect").addEventListener("change",J)}function J(){const e=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=e==="6"?"block":"none"}function U(){document.getElementById("resultBox").style.display="none",document.getElementById("submitBtn").style.display="block",document.getElementById("submitBtn").disabled=!1,document.getElementById("guessInput").disabled=!1,document.getElementById("guessBox").style.display="block",document.getElementById("guessInput").value="",x()}function Y(e,t){const r=document.getElementById("mixDescription"),s=Object.entries(e.mix_description).map(([n,o])=>`${n}: ${Math.round(o*100)}%`);if(e.regions&&Array.isArray(e.regions)){const n=e.regions.map(o=>`<span style="color:${t[o]||t.default}; font-weight:500; font-size:0.8em;">${o}</span>`);s.unshift(`<em>${n.join(" ")}</em>`)}r.innerHTML=s.join("<br>")}function V(e){var r;document.getElementById("submitBtn").style.display="none",document.getElementById("submitBtn").disabled=!0,document.getElementById("guessInput").disabled=!0,document.getElementById("score").innerText=I;const t=document.querySelector("#resultTable tbody");t.innerHTML="",e.top10.forEach((s,n)=>{var i;const o=document.createElement("tr");if(o.innerHTML=`<td>${n+1}. ${s.name}</td><td>${s.distance.toFixed(4)}</td>`,t.appendChild(o),n<3&&d[s.name]){const c=[9,7,5][n];d[s.name].setStyle({fillColor:"lime",radius:c}),(i=d[s.name].getElement())==null||i.classList.add("blink")}}),document.getElementById("resultMessage").innerHTML=`<div style="font-size: 0.8em;"><em>Your Guess:</em> ${e.rank}. ${e.guess} (${e.score} points!) ${((r=e.distance)==null?void 0:r.toFixed(4))??"?"}</div>`,document.getElementById("resultBox").style.display="block"}function K(){const e=document.getElementById("popSuggestions");e.innerHTML="",w.forEach(t=>{const r=document.createElement("option");r.value=t,e.appendChild(r)})}const X={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};async function Q(){const e=document.getElementById("regionSelect").value;let t=[];if(e==="6"&&(t=Array.from(document.querySelectorAll("#customRegions input:checked")).map(r=>r.value),t.length===0)){alert("Please select at least one region.");return}try{const r=await F(e,t);Y(r,X),U(),k(),B(!0),Object.entries(r.mix_description).forEach(([s])=>{d[s]&&d[s].setStyle({fillColor:"gold",radius:9})})}catch(r){console.error("startNewRound failed:",r),alert("Failed to generate new round.")}}function C(e){try{const t=H(e);N(!0),B(!1),V(t,d)}catch(t){console.error("submitGuess failed:",t),alert("Error scoring your guess.")}}window.addEventListener("DOMContentLoaded",async()=>{var r,s,n,o;await O(),K(),v(),D();function e(){if(M()){alert("You already guessed this round!");return}const i=document.getElementById("guessInput").value.trim();i!==""&&C(i)}const t=document.getElementById("guessInput");t==null||t.addEventListener("keypress",i=>{i.key==="Enter"&&e()}),(r=document.getElementById("submitBtn"))==null||r.addEventListener("click",e),(s=document.getElementById("regionSelect"))==null||s.addEventListener("change",()=>{const i=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=i==="6"?"block":"none"}),(n=document.querySelectorAll("#customRegions input"))==null||n.forEach(i=>{i.addEventListener("click",c=>c.stopPropagation())}),(o=document.getElementById("newRoundBtn"))==null||o.addEventListener("click",()=>{Q(),setTimeout(()=>{var i;(i=document.getElementById("guessInput"))==null||i.focus()},50)})});window.submitGuess=e=>{if(T()){if(M()){alert("You already guessed this round!");return}C(e)}};
