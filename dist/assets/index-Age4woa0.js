(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();let m={};const b={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};function _(){const e=L.map("map").setView([30,20],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e),fetch("/RaceGuessr/illu_modern_points.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{pointToLayer:(o,s)=>{const n=o.properties.Region||"default",r=L.circleMarker(s,{radius:6,fillColor:b[n]||b.default,color:"#000",weight:1,opacity:1,fillOpacity:.9});return m[o.properties.Population]=r,r},onEachFeature:(o,s)=>{const n=o.properties.Population,r=o.properties.Region;s.bindTooltip(`<strong>${n}</strong><br>Region: ${r}`),s.on("click",()=>{typeof window.submitGuess=="function"&&window.submitGuess(n)})}}).addTo(e)})}function q(){Object.keys(m).forEach(e=>{var o;m[e].setStyle({radius:6,fillColor:b[(o=m[e].feature)==null?void 0:o.properties.Region]||b.default});const t=m[e].getElement();t&&t.classList.remove("blink")})}const R={default:["European","MENA","WACA","EASEA","Siberian","American","SAO","SSA"],European:["MENA","WACA","Siberian"],MENA:["European","WACA","SAO","SSA"],WACA:["European","MENA","EASEA","Siberian","SAO"],EASEA:["WACA","Siberian","SAO"],Siberian:["European","WACA","EASEA","American"],American:["Siberian"],SAO:["MENA","WACA","EASEA","SSA"],SSA:["MENA","SAO"]},z=[100,80,70,60,50,44,38,32,26,20],D=[[1],[2,3,4],[5,6,7],[8]],U=[12,15,18,20,24,30,40,45],v=60;function V(e,t){return Math.sqrt(e.reduce((o,s,n)=>o+(s-t[n])**2,0))}let I=0,M=!1,w=!1;function E(){M=!1,w=!0}function A(e){M=e}function C(){return M}function N(e){w=e}function Y(){return w}function J(e){I+=e}function $(){I=0}let y=[],K=Array.from({length:25},(e,t)=>`PC${t+1}`),G=[],x={vector:null,results:null,mix:null,regions:null};async function j(){y=(await(await fetch("/RaceGuessr/illu_modern_points.geojson")).json()).features.map(s=>({name:s.properties.Population,region:s.properties.Region,coords:s.geometry.coordinates,vector:K.map(n=>s.properties[n])})),G=y.map(s=>s.name)}async function X(e,t=[]){y.length||await j();const o=H(e,t),s=y.filter(l=>o.includes(l.region)),n=Math.floor(Math.random()*3)+2,r=T(s,n);let i;do i=T(U,n,!0);while(i.reduce((l,u)=>l+u,0)!==v);const c=i.map(l=>l/v),a=ee(r.map(l=>l.vector),c),d=y.map(l=>({name:l.name,distance:100*V(l.vector,a)})).sort((l,u)=>l.distance-u.distance);return x={vector:a,results:d,mix:Object.fromEntries(r.map((l,u)=>[l.name,c[u]])),regions:o},{mix_description:x.mix,regions:o,populations:r.map(l=>l.name)}}function Q(e){const{results:t,vector:o,mix:s,regions:n}=x;if(!t)throw new Error("Round not initialized");const r=t.slice(0,10),i=r.map(u=>u.name),c=t.find(u=>u.name===e),a=t.findIndex(u=>u.name===e)+1,d=(c==null?void 0:c.distance)??null;let l;return i.includes(e)?l=z[i.indexOf(e)]:l=Z(e,t),J(l),{score:l,rank:a,distance:d,guess:e,top10:r,true_mix:s,regions:n}}function H(e,t=[]){if(e==="6")return t;if(e==="5"){const c=(Math.floor(Math.random()*4)+1).toString();return H(c)}const o=D[parseInt(e)-1],s=o[Math.floor(Math.random()*o.length)],n=R.default,r=n[Math.floor(Math.random()*n.length)],i=new Set([r]);for(;i.size<s;){const c=new Set;for(const l of i){const u=R[l]||[];for(const k of u)i.has(k)||c.add(k)}const a=Array.from(c);if(a.length===0)break;const d=a[Math.floor(Math.random()*a.length)];i.add(d)}return Array.from(i)}function Z(e,t){const o=t.find(r=>r.name===e);if(!o)return 0;const s=t.findIndex(r=>r.name===e),n=o.distance;if(s>=10&&s<20){const r=t[19].distance,i=t[10].distance;return Math.round(10+(r-n)/(r-i+1e-8)*10)}else if(s>=20&&s<50){const r=t[49].distance,i=t[20].distance;return Math.round((r-n)/(r-i+1e-8)*10)}return 0}function ee(e,t){const o=e[0].length,s=Array(o).fill(0);for(let n=0;n<o;n++)for(let r=0;r<e.length;r++)s[n]+=e[r][n]*t[r];return s}function T(e,t,o=!1){return o?Array.from({length:t},()=>e[Math.floor(Math.random()*e.length)]):[...e].sort(()=>.5-Math.random()).slice(0,t)}const te={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};async function h(){const e=document.getElementById("regionSelect").value;let t=[];if(e==="6"&&(t=Array.from(document.querySelectorAll("#customRegions input:checked")).map(o=>o.value),t.length===0)){alert("Please select at least one region.");return}try{const o=await X(e,t);se(o,te),B(),E(),N(!0),Object.entries(o.mix_description).forEach(([s])=>{m[s]&&m[s].setStyle({fillColor:"gold",radius:10})})}catch(o){console.error("startNewRound failed:",o),alert("Failed to generate new round.")}}function F(e){try{const t=Q(e);A(!0),N(!1),re(t,m)}catch(t){console.error("submitGuess failed:",t),alert("Error scoring your guess.")}}let f=null,p=0,g=0;function ne(){document.getElementById("regionSelect").addEventListener("change",oe)}function oe(){const e=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=e==="6"?"block":"none"}function B(){document.getElementById("resultBox").style.display="none",document.getElementById("submitBtn").style.display="block",document.getElementById("submitBtn").disabled=!1,document.getElementById("guessInput").disabled=!1,document.getElementById("guessBox").style.display="block",document.getElementById("guessInput").value="",q()}function se(e,t){const o=document.getElementById("mixDescription"),s=Object.entries(e.mix_description).map(([n,r])=>`${n}: ${Math.round(r*100)}%`);if(e.regions&&Array.isArray(e.regions)){const n=e.regions.map(r=>`<span style="color:${t[r]||t.default}; font-weight:500; font-size:0.8em;">${r}</span>`);s.unshift(`<em>${n.join(" ")}</em>`)}o.innerHTML=s.join("<br>")}function re(e){var o;document.getElementById("submitBtn").style.display="none",document.getElementById("submitBtn").disabled=!0,document.getElementById("guessInput").disabled=!0,document.getElementById("score").innerText=I;const t=document.querySelector("#resultTable tbody");if(t.innerHTML="",e.top10.forEach((s,n)=>{var c,a;const r=O(s.distance),i=document.createElement("tr");if(e.rank===n+1?i.innerHTML=`
        <td><strong>${n+1}. ${e.guess}</strong><br>(${e.score} points!)</td>
        <td style="color:${r}"><strong>${((c=e.distance)==null?void 0:c.toFixed(4))??"?"}</strong></td>
      </tr>`:i.innerHTML=`
        <td>${n+1}. ${s.name}</td>
        <td style="color:${r}">${s.distance.toFixed(4)}</td>
      </tr>`,t.appendChild(i),n<5&&m[s.name]){const d=[10,9,8,7,6][n];m[s.name].setStyle({fillColor:"lime",radius:d}),(a=m[s.name].getElement())==null||a.classList.add("blink")}}),e.rank>10){const s=O(e.distance),n=document.createElement("tr");n.innerHTML=`
      <td><strong>${e.rank}. ${e.guess}</strong><br>(${e.score} points!)</td>
      <td style="color:${s}"><strong>${((o=e.distance)==null?void 0:o.toFixed(4))??"?"}</strong></td>
    </tr>`,t.appendChild(n)}document.getElementById("resultBox").style.display="block",f==="compete"&&(g+=e.score,document.getElementById("score").textContent=g,p===10?(W(g),f=null,p=0,g=0,S(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none"):document.getElementById("nextRoundBtn").disabled=!1)}function ie(){const e=document.getElementById("popSuggestions");e.innerHTML="",G.forEach(t=>{const o=document.createElement("option");o.value=t,e.appendChild(o)})}function le(){document.getElementById("regionSelect").disabled=!0,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!0})}function S(){document.getElementById("regionSelect").disabled=!1,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!1})}function ce(){const e=document.getElementById("practiceBtn"),t=document.getElementById("competeBtn"),o=document.getElementById("nextRoundBtn"),s=document.getElementById("quitBtn");e==null||e.addEventListener("click",()=>{f="practice",S(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",E(),B(),document.getElementById("score").textContent=I,h()}),t==null||t.addEventListener("click",()=>{f="compete",p=1,g=0,A(!1),le(),document.getElementById("modeButtons").style.display="none",document.getElementById("competeControls").style.display="block",document.getElementById("roundCounter").textContent=`Round: ${p} / 10`,E(),B(),document.getElementById("score").textContent="0",document.getElementById("nextRoundBtn").disabled=!0,h()}),o==null||o.addEventListener("click",()=>{C()&&(p++,p>10?(W(g),f=null,p=0,g=0,$(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",S()):(A(!1),E(),B(),document.getElementById("roundCounter").textContent=`Round: ${p} / 10`,document.getElementById("nextRoundBtn").disabled=!0,h()))}),s==null||s.addEventListener("click",()=>{f=null,p=0,g=0,$(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",S()})}function de(e){return{1:"Single",2:"Multiple",3:"Majority",4:"Global",5:"Random",6:"Custom"}[e]||"Unknown"}function ae(){return Array.from(document.querySelectorAll("#customRegions input[type=checkbox]:checked")).map(e=>({name:e.value,color:e.style.color||"black"}))}function W(e){const t=document.getElementById("regionSelect").value,o=de(t),s=document.getElementById("finalResultPopup"),n=document.getElementById("finalResultText"),r=document.getElementById("finalResultSubtext");if(n.innerText=`You scored ${e} points!`,t==="6"){const i=ae();i.length===0?r.innerText="(No custom regions selected)":r.innerHTML=i.map(c=>`<span style="color:${c.color}; font-weight:bold;">${c.name}</span>`).join(" ")}else r.innerText=`${o} Mode`;s.style.display="block"}function O(e){return e<1?"lime":e<3?"green":e<5?"orange":e<6?"red":"darkblue"}window.addEventListener("DOMContentLoaded",async()=>{var n,r,i,c,a;await j(),ie(),_(),ne(),ce();const e=document.getElementById("howToPlayPopup");!localStorage.getItem("seenIntro")&&e&&(e.style.display="flex",setTimeout(()=>e.classList.add("visible"),10),(n=document.getElementById("popupCloseBtn"))==null||n.addEventListener("click",()=>{e.style.display="none",localStorage.setItem("seenIntro","true")}));function o(){if(C()){alert("You already guessed this round!");return}const d=document.getElementById("guessInput").value.trim();d!==""&&F(d)}const s=document.getElementById("guessInput");s==null||s.addEventListener("keypress",d=>{d.key==="Enter"&&o()}),(r=document.getElementById("submitBtn"))==null||r.addEventListener("click",o),(i=document.getElementById("regionSelect"))==null||i.addEventListener("change",()=>{const d=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=d==="6"?"block":"none"}),(c=document.querySelectorAll("#customRegions input"))==null||c.forEach(d=>{d.addEventListener("click",l=>l.stopPropagation())}),(a=document.getElementById("newRoundBtn"))==null||a.addEventListener("click",()=>{h(),setTimeout(()=>{var d;(d=document.getElementById("guessInput"))==null||d.focus()},50)})});window.submitGuess=e=>{if(Y()){if(C()){alert("You already guessed this round!");return}F(e)}};window.showPopupPage=function(e){for(let t=1;t<=3;t++){const o=document.getElementById(`popupPage${t}`);o&&(o.style.display=t===e?"block":"none",t===e&&o.classList.add("slide-in"))}};function ue(){const e=document.getElementById("howToPlayPopup");e.style.display="flex",setTimeout(()=>e.classList.add("visible"),10)}ue();var P;(P=document.getElementById("popupCloseBtn"))==null||P.addEventListener("click",()=>{document.getElementById("howToPlayPopup").style.display="none"});
