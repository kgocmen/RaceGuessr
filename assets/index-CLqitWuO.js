(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();let m={};const A={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};function q(){const e=L.map("map",{center:[20,0],zoom:2,minZoom:2.1,zoomSnap:.1,zoomDelta:.1,worldCopyJump:!1,maxBounds:[[-80,-270],[80,270]]});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e),fetch("/RaceGuessr/illu_modern_points.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{pointToLayer:(s,n)=>{const o=s.properties.Region||"default",r=L.circleMarker(n,{radius:6,fillColor:A[o]||A.default,color:"#000",weight:1,opacity:1,fillOpacity:.9});return m[s.properties.Population]=r,r},onEachFeature:(s,n)=>{const o=s.properties.Population,r=s.properties.Region;n.bindTooltip(`<strong>${o}</strong><br>Region: ${r}`,{direction:"top",sticky:!0,className:"custom-tooltip"});const l=()=>{typeof window.submitGuess=="function"&&window.submitGuess(o)};n.on("click",l),n.on("touchend",c=>{c.originalEvent.preventDefault(),l()})}}).addTo(e)})}function D(){Object.keys(m).forEach(e=>{var s;m[e].setStyle({radius:6,fillColor:A[(s=m[e].feature)==null?void 0:s.properties.Region]||A.default});const t=m[e].getElement();t&&t.classList.remove("blink")})}const v={default:["European","MENA","WACA","EASEA","Siberian","American","SAO","SSA"],European:["MENA","WACA","Siberian"],MENA:["European","WACA","SAO","SSA"],WACA:["European","MENA","EASEA","Siberian","SAO"],EASEA:["WACA","Siberian","SAO"],Siberian:["European","WACA","EASEA","American"],American:["Siberian"],SAO:["MENA","WACA","EASEA","SSA"],SSA:["MENA","SAO"]},U=[100,80,70,60,50,44,38,32,26,20],J=[[1],[2,3,4],[5,6,7],[8]],V=[12,15,18,20,24,30,40,45],T=60;function Y(e,t){return Math.sqrt(e.reduce((s,n,o)=>s+(n-t[o])**2,0))}let w=0,k=!1,M=!1;function B(){k=!1,M=!0}function C(e){k=e}function G(){return k}function j(e){M=e}function K(){return M}function X(e){w+=e}function $(){w=0}let E=[],Z=Array.from({length:25},(e,t)=>`PC${t+1}`),R=[],x={vector:null,results:null,mix:null,regions:null};async function z(){E=(await(await fetch("/RaceGuessr/illu_modern_points.geojson")).json()).features.map(n=>({name:n.properties.Population,region:n.properties.Region,coords:n.geometry.coordinates,vector:Z.map(o=>n.properties[o])})),R=E.map(n=>n.name)}async function Q(e,t=[]){E.length||await z();const s=H(e,t),n=E.filter(i=>s.includes(i.region)),o=Math.floor(Math.random()*3)+2,r=O(n,o);let l;do l=O(V,o,!0);while(l.reduce((i,a)=>i+a,0)!==T);const c=l.map(i=>i/T),d=ne(r.map(i=>i.vector),c),u=E.map(i=>({name:i.name,distance:100*Y(i.vector,d)})).sort((i,a)=>i.distance-a.distance);return x={vector:d,results:u,mix:Object.fromEntries(r.map((i,a)=>[i.name,c[a]])),regions:s},{mix_description:x.mix,regions:s,populations:r.map(i=>i.name)}}function ee(e){const{results:t,vector:s,mix:n,regions:o}=x;if(!t)throw new Error("Round not initialized");const r=t.slice(0,10),l=r.map(a=>a.name),c=t.find(a=>a.name===e),d=t.findIndex(a=>a.name===e)+1,u=(c==null?void 0:c.distance)??null;let i;return l.includes(e)?i=U[l.indexOf(e)]:i=te(e,t),X(i),{score:i,rank:d,distance:u,guess:e,top10:r,true_mix:n,regions:o}}function H(e,t=[]){if(e==="6")return t;if(e==="5"){const c=(Math.floor(Math.random()*4)+1).toString();return H(c)}const s=J[parseInt(e)-1],n=s[Math.floor(Math.random()*s.length)],o=v.default,r=o[Math.floor(Math.random()*o.length)],l=new Set([r]);for(;l.size<n;){const c=new Set;for(const i of l){const a=v[i]||[];for(const y of a)l.has(y)||c.add(y)}const d=Array.from(c);if(d.length===0)break;const u=d[Math.floor(Math.random()*d.length)];l.add(u)}return Array.from(l)}function te(e,t){const s=t.find(r=>r.name===e);if(!s)return 0;const n=t.findIndex(r=>r.name===e),o=s.distance;if(n>=10&&n<20){const r=t[19].distance,l=t[10].distance;return Math.round(10+(r-o)/(r-l+1e-8)*10)}else if(n>=20&&n<50){const r=t[49].distance,l=t[20].distance;return Math.round((r-o)/(r-l+1e-8)*10)}return 0}function ne(e,t){const s=e[0].length,n=Array(s).fill(0);for(let o=0;o<s;o++)for(let r=0;r<e.length;r++)n[o]+=e[r][o]*t[r];return n}function O(e,t,s=!1){return s?Array.from({length:t},()=>e[Math.floor(Math.random()*e.length)]):[...e].sort(()=>.5-Math.random()).slice(0,t)}const oe={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};async function S(){const e=document.getElementById("regionSelect").value;let t=[];if(e==="6"&&(t=Array.from(document.querySelectorAll("#customRegions input:checked")).map(s=>s.value),t.length===0)){alert("Please select at least one region.");return}try{const s=await Q(e,t);le(s,oe),I(),B(),j(!0),Object.entries(s.mix_description).forEach(([n])=>{m[n]&&m[n].setStyle({fillColor:"gold",radius:10})})}catch(s){console.error("startNewRound failed:",s),alert("Failed to generate new round.")}}function W(e){try{const t=ee(e);C(!0),j(!1),ie(t,m)}catch(t){console.error("submitGuess failed:",t),alert("Error scoring your guess.")}}let f=null,p=0,g=0;function se(){document.getElementById("regionSelect").addEventListener("change",re)}function re(){const e=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=e==="6"?"block":"none"}function I(){document.getElementById("resultBox").style.display="none",document.getElementById("submitBtn").style.display="block",document.getElementById("submitBtn").disabled=!1,document.getElementById("guessInput").disabled=!1,document.getElementById("guessBox").style.display="block",document.getElementById("guessInput").value="",D()}function le(e,t){const s=document.getElementById("mixDescription"),n=Object.entries(e.mix_description).map(([o,r])=>`${o}: ${Math.round(r*100)}%`);if(e.regions&&Array.isArray(e.regions)){const o=e.regions.map(r=>`<span style="color:${t[r]||t.default}; font-weight:500; font-size:0.8em;">${r}</span>`);n.unshift(`<em>${o.join(" ")}</em>`)}s.innerHTML=n.join("<br>")}function ie(e){var s;document.getElementById("submitBtn").style.display="none",document.getElementById("submitBtn").disabled=!0,document.getElementById("guessInput").disabled=!0,document.getElementById("score").innerText=w;const t=document.querySelector("#resultTable tbody");if(t.innerHTML="",e.top10.forEach((n,o)=>{var c,d;const r=N(n.distance),l=document.createElement("tr");if(e.rank===o+1?l.innerHTML=`
        <td><strong>${o+1}. ${e.guess}</strong><br>(${e.score} points!)</td>
        <td style="color:${r}"><strong>${((c=e.distance)==null?void 0:c.toFixed(4))??"?"}</strong></td>
      </tr>`:l.innerHTML=`
        <td>${o+1}. ${n.name}</td>
        <td style="color:${r}">${n.distance.toFixed(4)}</td>
      </tr>`,t.appendChild(l),o<5&&m[n.name]){const u=[10,9,8,7,6][o];m[n.name].setStyle({fillColor:"lime",radius:u}),(d=m[n.name].getElement())==null||d.classList.add("blink")}}),e.rank>10){const n=N(e.distance),o=document.createElement("tr");o.innerHTML=`
      <td><strong>${e.rank}. ${e.guess}</strong><br>(${e.score} points!)</td>
      <td style="color:${n}"><strong>${((s=e.distance)==null?void 0:s.toFixed(4))??"?"}</strong></td>
    </tr>`,t.appendChild(o)}document.getElementById("resultBox").style.display="block",f==="compete"&&(g+=e.score,document.getElementById("score").textContent=g,p===10?(F(g),f=null,p=0,g=0,b(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none"):document.getElementById("nextRoundBtn").disabled=!1)}function ce(){const e=document.getElementById("popSuggestions");e.innerHTML="",R.forEach(t=>{const s=document.createElement("option");s.value=t,e.appendChild(s)})}function de(){document.getElementById("regionSelect").disabled=!0,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!0})}function b(){document.getElementById("regionSelect").disabled=!1,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!1})}function ae(){const e=document.getElementById("practiceBtn"),t=document.getElementById("competeBtn"),s=document.getElementById("nextRoundBtn"),n=document.getElementById("quitBtn");e==null||e.addEventListener("click",()=>{f="practice",b(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",B(),I(),document.getElementById("score").textContent=w,S()}),t==null||t.addEventListener("click",()=>{f="compete",p=1,g=0,C(!1),de(),document.getElementById("modeButtons").style.display="none",document.getElementById("competeControls").style.display="block",document.getElementById("roundCounter").textContent=`Round: ${p} / 10`,B(),I(),document.getElementById("score").textContent="0",document.getElementById("nextRoundBtn").disabled=!0,S()}),s==null||s.addEventListener("click",()=>{G()&&(p++,p>10?(F(g),f=null,p=0,g=0,$(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",b()):(C(!1),B(),I(),document.getElementById("roundCounter").textContent=`Round: ${p} / 10`,document.getElementById("nextRoundBtn").disabled=!0,S()))}),n==null||n.addEventListener("click",()=>{f=null,p=0,g=0,$(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",b()})}function ue(e){return{1:"Single",2:"Multiple",3:"Majority",4:"Global",5:"Random",6:"Custom"}[e]||"Unknown"}function me(){return Array.from(document.querySelectorAll("#customRegions input[type=checkbox]:checked")).map(e=>({name:e.value,color:e.style.color||"black"}))}function F(e){const t=document.getElementById("regionSelect").value,s=ue(t),n=document.getElementById("finalResultPopup"),o=document.getElementById("finalResultText"),r=document.getElementById("finalResultSubtext");if(o.innerText=`You scored ${e} points!`,t==="6"){const l=me();l.length===0?r.innerText="(No custom regions selected)":r.innerHTML=l.map(c=>`<span style="color:${c.color}; font-weight:bold;">${c.name}</span>`).join(" ")}else r.innerText=`${s} Mode`;n.style.display="block"}function N(e){return e<1?"lime":e<3?"green":e<5?"orange":e<6?"red":"darkblue"}window.addEventListener("DOMContentLoaded",async()=>{var o,r,l,c;await z(),ce(),q(),se(),ae();const e=document.getElementById("howToPlayPopup");!localStorage.getItem("seenIntro")&&e&&(e.style.display="flex",setTimeout(()=>e.classList.add("visible"),10),(o=document.getElementById("popupCloseBtn"))==null||o.addEventListener("click",()=>{e.style.display="none",localStorage.setItem("seenIntro","true")}));function s(){const d=h=>h.toLowerCase().replace(/\s+/g,""),u={};R.forEach(h=>{const _=h.toLowerCase().replace(/\s+/g,"");u[_]=h});const i=document.getElementById("guessInput").value.trim(),a=d(i),y=u[a];if(!y){alert("That population does not exist. Please try again.");return}W(y)}const n=document.getElementById("guessInput");n==null||n.addEventListener("keydown",d=>{if(d.key==="Enter"&&s(),d.key==="Tab"){const u=document.querySelectorAll("#popSuggestions option");for(const i of u)if(i.value.toLowerCase().startsWith(n.value.toLowerCase())){d.preventDefault(),n.value=i.value;break}}}),(r=document.getElementById("submitBtn"))==null||r.addEventListener("click",s),(l=document.getElementById("regionSelect"))==null||l.addEventListener("change",()=>{const d=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=d==="6"?"block":"none"}),(c=document.getElementById("newRoundBtn"))==null||c.addEventListener("click",()=>{S(),setTimeout(()=>{var d;(d=document.getElementById("guessInput"))==null||d.focus()},50)})});window.submitGuess=e=>{if(K()){if(G()){alert("You already guessed this round!");return}W(e)}};window.showPopupPage=function(e){for(let t=1;t<=3;t++){const s=document.getElementById(`popupPage${t}`);s&&(s.style.display=t===e?"block":"none",t===e&&s.classList.add("slide-in"))}};function pe(){const e=document.getElementById("howToPlayPopup");e.style.display="flex",setTimeout(()=>e.classList.add("visible"),10)}pe();var P;(P=document.getElementById("popupCloseBtn"))==null||P.addEventListener("click",()=>{document.getElementById("howToPlayPopup").style.display="none"});
