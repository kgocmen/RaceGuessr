(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();let u={};const b={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};function H(){const e=L.map("map").setView([30,20],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e),fetch("/RaceGuessr/illu_modern_points.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{pointToLayer:(o,s)=>{const r=o.properties.Region||"default",n=L.circleMarker(s,{radius:6,fillColor:b[r]||b.default,color:"#000",weight:1,opacity:1,fillOpacity:.9});return u[o.properties.Population]=n,n},onEachFeature:(o,s)=>{const r=o.properties.Population,n=o.properties.Region;s.bindTooltip(`<strong>${r}</strong><br>Region: ${n}`),s.on("click",()=>{typeof window.submitGuess=="function"&&window.submitGuess(r)})}}).addTo(e)})}function _(){Object.keys(u).forEach(e=>{var o;u[e].setStyle({radius:6,fillColor:b[(o=u[e].feature)==null?void 0:o.properties.Region]||b.default});const t=u[e].getElement();t&&t.classList.remove("blink")})}const w={default:["European","MENA","WACA","EASEA","Siberian","American","SAO","SSA"],European:["MENA","WACA","Siberian"],MENA:["European","WACA","SAO","SSA"],WACA:["European","MENA","EASEA","Siberian","SAO"],EASEA:["WACA","Siberian","SAO"],Siberian:["European","WACA","EASEA","American"],American:["Siberian"],SAO:["MENA","WACA","EASEA","SSA"],SSA:["MENA","SAO"]},q=[100,80,70,60,50,44,38,32,26,20],z=[[1],[2,3,4],[5,6,7],[8]],D=[12,15,18,20,24,30,40,45],O=60;function U(e,t){return Math.sqrt(e.reduce((o,s,r)=>o+(s-t[r])**2,0))}let B=0,x=!1,C=!1;function E(){x=!1,C=!0}function I(e){x=e}function R(){return x}function T(e){C=e}function V(){return C}function Y(e){B+=e}function v(){B=0}let y=[],J=Array.from({length:25},(e,t)=>`PC${t+1}`),G=[],M={vector:null,results:null,mix:null,regions:null};async function P(){y=(await(await fetch("/RaceGuessr/illu_modern_points.geojson")).json()).features.map(s=>({name:s.properties.Population,region:s.properties.Region,coords:s.geometry.coordinates,vector:J.map(r=>s.properties[r])})),G=y.map(s=>s.name)}async function K(e,t=[]){y.length||await P();const o=j(e,t),s=y.filter(c=>o.includes(c.region)),r=Math.floor(Math.random()*3)+2,n=$(s,r);let i;do i=$(D,r,!0);while(i.reduce((c,d)=>c+d,0)!==O);const l=i.map(c=>c/O),a=Z(n.map(c=>c.vector),l),g=y.map(c=>({name:c.name,distance:100*U(c.vector,a)})).sort((c,d)=>c.distance-d.distance);return M={vector:a,results:g,mix:Object.fromEntries(n.map((c,d)=>[c.name,l[d]])),regions:o},{mix_description:M.mix,regions:o,populations:n.map(c=>c.name)}}function X(e){const{results:t,vector:o,mix:s,regions:r}=M;if(!t)throw new Error("Round not initialized");const n=t.slice(0,10),i=n.map(d=>d.name),l=t.find(d=>d.name===e),a=t.findIndex(d=>d.name===e)+1,g=(l==null?void 0:l.distance)??null;let c;return i.includes(e)?c=q[i.indexOf(e)]:(console.log("here"),c=Q(e,t)),Y(c),{score:c,rank:a,distance:g,guess:e,top10:n,true_mix:s,regions:r}}function j(e,t=[]){if(e==="6")return t;if(e==="5"){const l=(Math.floor(Math.random()*4)+1).toString();return j(l)}const o=z[parseInt(e)-1],s=o[Math.floor(Math.random()*o.length)],r=w.default,n=r[Math.floor(Math.random()*r.length)],i=new Set([n]);for(;i.size<s;){const l=new Set;for(const c of i){const d=w[c]||[];for(const k of d)i.has(k)||l.add(k)}const a=Array.from(l);if(a.length===0)break;const g=a[Math.floor(Math.random()*a.length)];i.add(g)}return Array.from(i)}function Q(e,t){const o=t.find(n=>n.name===e);if(!o)return 0;const s=t.findIndex(n=>n.name===e),r=o.distance;if(s>=10&&s<20){const n=t[19].distance,i=t[10].distance;return Math.round(10+(n-r)/(n-i+1e-8)*10)}else if(s>=20&&s<50){const n=t[49].distance,i=t[20].distance;return Math.round((n-r)/(n-i+1e-8)*10)}return 0}function Z(e,t){const o=e[0].length,s=Array(o).fill(0);for(let r=0;r<o;r++)for(let n=0;n<e.length;n++)s[r]+=e[n][r]*t[n];return s}function $(e,t,o=!1){return o?Array.from({length:t},()=>e[Math.floor(Math.random()*e.length)]):[...e].sort(()=>.5-Math.random()).slice(0,t)}const ee={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};async function h(){const e=document.getElementById("regionSelect").value;let t=[];if(e==="6"&&(t=Array.from(document.querySelectorAll("#customRegions input:checked")).map(o=>o.value),t.length===0)){alert("Please select at least one region.");return}try{const o=await K(e,t);oe(o,ee),S(),E(),T(!0),Object.entries(o.mix_description).forEach(([s])=>{u[s]&&u[s].setStyle({fillColor:"gold",radius:10})})}catch(o){console.error("startNewRound failed:",o),alert("Failed to generate new round.")}}function W(e){try{const t=X(e);I(!0),T(!1),re(t,u)}catch(t){console.error("submitGuess failed:",t),alert("Error scoring your guess.")}}let f=null,m=0,p=0;function te(){document.getElementById("regionSelect").addEventListener("change",ne)}function ne(){const e=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=e==="6"?"block":"none"}function S(){document.getElementById("resultBox").style.display="none",document.getElementById("submitBtn").style.display="block",document.getElementById("submitBtn").disabled=!1,document.getElementById("guessInput").disabled=!1,document.getElementById("guessBox").style.display="block",document.getElementById("guessInput").value="",_()}function oe(e,t){const o=document.getElementById("mixDescription"),s=Object.entries(e.mix_description).map(([r,n])=>`${r}: ${Math.round(n*100)}%`);if(e.regions&&Array.isArray(e.regions)){const r=e.regions.map(n=>`<span style="color:${t[n]||t.default}; font-weight:500; font-size:0.8em;">${n}</span>`);s.unshift(`<em>${r.join(" ")}</em>`)}o.innerHTML=s.join("<br>")}function re(e){var r;document.getElementById("submitBtn").style.display="none",document.getElementById("submitBtn").disabled=!0,document.getElementById("guessInput").disabled=!0,document.getElementById("score").innerText=B;const t=document.querySelector("#resultTable tbody");t.innerHTML="",e.top10.forEach((n,i)=>{var g;const l=N(n.distance),a=document.createElement("tr");if(a.innerHTML=`
      <td>${i+1}. ${n.name}</td>
      <td style="color:${l}">${n.distance.toFixed(4)}</td>
    `,t.appendChild(a),i<5&&u[n.name]){const c=[10,9,8,7,6][i];u[n.name].setStyle({fillColor:"lime",radius:c}),(g=u[n.name].getElement())==null||g.classList.add("blink")}});const o=N(e.distance),s=document.createElement("tr");s.innerHTML=`
    <td><strong>${e.rank}. ${e.guess}</strong>  (${e.score} points!)</td>
    <td style="color:${o}"><strong>${((r=e.distance)==null?void 0:r.toFixed(4))??"?"}</strong></td>
  `,t.appendChild(s),document.getElementById("resultBox").style.display="block",f==="compete"&&(p+=e.score,document.getElementById("score").textContent=p,m===10?(F(p),f=null,m=0,p=0,A(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none"):document.getElementById("nextRoundBtn").disabled=!1)}function se(){const e=document.getElementById("popSuggestions");e.innerHTML="",G.forEach(t=>{const o=document.createElement("option");o.value=t,e.appendChild(o)})}function ie(){document.getElementById("regionSelect").disabled=!0,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!0})}function A(){document.getElementById("regionSelect").disabled=!1,document.querySelectorAll("#customRegions input[type=checkbox]").forEach(e=>{e.disabled=!1})}function ce(){const e=document.getElementById("practiceBtn"),t=document.getElementById("competeBtn"),o=document.getElementById("nextRoundBtn"),s=document.getElementById("quitBtn");e==null||e.addEventListener("click",()=>{f="practice",A(),document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",E(),S(),document.getElementById("score").textContent=B,h()}),t==null||t.addEventListener("click",()=>{f="compete",m=1,p=0,I(!1),ie(),document.getElementById("modeButtons").style.display="none",document.getElementById("competeControls").style.display="block",document.getElementById("roundCounter").textContent=`Round: ${m} / 10`,E(),S(),document.getElementById("score").textContent="0",document.getElementById("nextRoundBtn").disabled=!0,h()}),o==null||o.addEventListener("click",()=>{R()&&(m++,m>10?(F(p),f=null,m=0,p=0,v(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",A()):(I(!1),E(),S(),document.getElementById("roundCounter").textContent=`Round: ${m} / 10`,document.getElementById("nextRoundBtn").disabled=!0,h()))}),s==null||s.addEventListener("click",()=>{f=null,m=0,p=0,v(),document.getElementById("score").textContent="0",document.getElementById("modeButtons").style.display="block",document.getElementById("competeControls").style.display="none",A()})}function le(e){return{1:"Single",2:"Multiple",3:"Majority",4:"Global",5:"Random",6:"Custom"}[e]||"Unknown"}function de(){return Array.from(document.querySelectorAll("#customRegions input[type=checkbox]:checked")).map(e=>({name:e.value,color:e.style.color||"black"}))}function F(e){const t=document.getElementById("regionSelect").value,o=le(t),s=document.getElementById("finalResultPopup"),r=document.getElementById("finalResultText"),n=document.getElementById("finalResultSubtext");if(r.innerText=`You scored ${e} points!`,t==="6"){const i=de();i.length===0?n.innerText="(No custom regions selected)":n.innerHTML=i.map(l=>`<span style="color:${l.color}; font-weight:bold;">${l.name}</span>`).join(" ")}else n.innerText=`${o} Mode`;s.style.display="block"}function N(e){return e<1?"lime":e<3?"green":e<5?"orange":e<6?"red":"darkblue"}window.addEventListener("DOMContentLoaded",async()=>{var o,s,r,n;await P(),se(),H(),te(),ce();function e(){if(R()){alert("You already guessed this round!");return}const i=document.getElementById("guessInput").value.trim();i!==""&&W(i)}const t=document.getElementById("guessInput");t==null||t.addEventListener("keypress",i=>{i.key==="Enter"&&e()}),(o=document.getElementById("submitBtn"))==null||o.addEventListener("click",e),(s=document.getElementById("regionSelect"))==null||s.addEventListener("change",()=>{const i=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=i==="6"?"block":"none"}),(r=document.querySelectorAll("#customRegions input"))==null||r.forEach(i=>{i.addEventListener("click",l=>l.stopPropagation())}),(n=document.getElementById("newRoundBtn"))==null||n.addEventListener("click",()=>{h(),setTimeout(()=>{var i;(i=document.getElementById("guessInput"))==null||i.focus()},50)})});window.submitGuess=e=>{if(V()){if(R()){alert("You already guessed this round!");return}W(e)}};
