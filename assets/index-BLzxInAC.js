(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();let d={};const p={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};function x(){const e=L.map("map").setView([30,20],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e),fetch("ne_110m_land.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{style:{color:"#999",weight:1,fillColor:"#ddd",fillOpacity:.6}}).addTo(e)}),fetch("illu_modern_points.geojson").then(t=>t.json()).then(t=>{L.geoJSON(t,{pointToLayer:(n,i)=>{const r=n.properties.Region||"default",o=L.circleMarker(i,{radius:5,fillColor:p[r]||p.default,color:"#000",weight:1,opacity:1,fillOpacity:.9});return d[n.properties.Population]=o,o},onEachFeature:(n,i)=>{const r=n.properties.Population,o=n.properties.Region;i.bindTooltip(`<strong>${r}</strong><br>Region: ${o}`),i.on("click",()=>{typeof window.submitGuess=="function"&&window.submitGuess(r)})}}).addTo(e)})}function R(){Object.keys(d).forEach(e=>{var n;d[e].setStyle({radius:5,fillColor:p[(n=d[e].feature)==null?void 0:n.properties.Region]||p.default});const t=d[e].getElement();t&&t.classList.remove("blink")})}let I=0,y=!1,E=!1;function k(){y=!1,E=!0}function N(e){y=e}function M(){return y}function B(e){E=e}function T(){return E}function $(e){I+=e}const A={default:["European","MENA","WACA","EASEA","Siberian","American","SAO","SSA"],European:["MENA","WACA","Siberian"],MENA:["European","WACA","SAO","SSA"],WACA:["European","MENA","EASEA","Siberian","SAO"],EASEA:["WACA","Siberian","SAO"],Siberian:["European","WACA","EASEA","American"],American:["Siberian"],SAO:["MENA","WACA","EASEA","SSA"],SSA:["MENA","SAO"]},j=[100,80,70,60,50,44,38,32,26,20],G=[[1],[2,3,4],[5,6,7],[8]],P=[12,15,18,20,24,30,40,45],S=60;function _(e,t){return Math.sqrt(e.reduce((n,i,r)=>n+(i-t[r])**2,0))}let f=[],W=Array.from({length:25},(e,t)=>`PC${t+1}`),w=[],g={vector:null,results:null,mix:null,regions:null};async function O(){f=(await(await fetch("illu_modern_points.geojson")).json()).features.map(n=>({name:n.properties.Population,region:n.properties.Region,coords:n.geometry.coordinates,vector:W.map(i=>n.properties[i])})),w=f.map(n=>n.name)}async function F(e,t=[]){f.length||await O();const n=C(e,t),i=f.filter(a=>n.includes(a.region)),r=Math.floor(Math.random()*3)+2,o=b(i,r);let s;do s=b(P,r,!0);while(s.reduce((a,l)=>a+l,0)!==S);const c=s.map(a=>a/S),u=q(o.map(a=>a.vector),c),m=f.map(a=>({name:a.name,distance:100*_(a.vector,u)})).sort((a,l)=>a.distance-l.distance);return g={vector:u,results:m,mix:Object.fromEntries(o.map((a,l)=>[a.name,c[l]])),regions:n},{mix_description:g.mix,regions:n,populations:o.map(a=>a.name)}}function H(e){const{results:t,vector:n,mix:i,regions:r}=g;if(!t)throw new Error("Round not initialized");const o=t.slice(0,10),s=o.map(l=>l.name),c=t.find(l=>l.name===e),u=t.findIndex(l=>l.name===e)+1,m=(c==null?void 0:c.distance)??null;let a;return s.includes(e)?a=j[s.indexOf(e)]:a=z(e,n),$(a),{score:a,rank:u,distance:m,guess:e,top10:o,true_mix:i,regions:r}}function C(e,t=[]){if(e==="6")return t;if(e==="5"){const c=(Math.floor(Math.random()*4)+1).toString();return C(c)}const n=G[parseInt(e)-1],i=n[Math.floor(Math.random()*n.length)],r=A.default,o=r[Math.floor(Math.random()*r.length)],s=new Set([o]);for(;s.size<i;){const c=new Set;for(const a of s){const l=A[a]||[];for(const h of l)s.has(h)||c.add(h)}const u=Array.from(c);if(u.length===0)break;const m=u[Math.floor(Math.random()*u.length)];s.add(m)}return Array.from(s)}function z(e,t){const n=t.find(o=>o.name===e);if(!n)return 0;const i=t.findIndex(o=>o.name===e),r=n.distance;if(i>=10&&i<20){const o=t[19].distance,s=t[10].distance;return Math.round(10+(o-r)/(o-s+1e-8)*10)}else if(i>=20&&i<50){const o=t[49].distance,s=t[20].distance;return Math.round((o-r)/(o-s+1e-8)*10)}return 0}function q(e,t){const n=e[0].length,i=Array(n).fill(0);for(let r=0;r<n;r++)for(let o=0;o<e.length;o++)i[r]+=e[o][r]*t[o];return i}function b(e,t,n=!1){return n?Array.from({length:t},()=>e[Math.floor(Math.random()*e.length)]):[...e].sort(()=>.5-Math.random()).slice(0,t)}function D(){document.getElementById("regionSelect").addEventListener("change",J)}function J(){const e=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=e==="6"?"block":"none"}function U(){document.getElementById("resultBox").style.display="none",document.getElementById("submitBtn").style.display="block",document.getElementById("submitBtn").disabled=!1,document.getElementById("guessInput").disabled=!1,document.getElementById("guessBox").style.display="block",document.getElementById("guessInput").value="",R()}function Y(e,t){const n=document.getElementById("mixDescription"),i=Object.entries(e.mix_description).map(([r,o])=>`${r}: ${Math.round(o*100)}%`);if(e.regions&&Array.isArray(e.regions)){const r=e.regions.map(o=>`<span style="color:${t[o]||t.default}; font-weight:500; font-size:0.8em;">${o}</span>`);i.unshift(`<em>${r.join(" ")}</em>`)}n.innerHTML=i.join("<br>")}function V(e){var n;document.getElementById("submitBtn").style.display="none",document.getElementById("submitBtn").disabled=!0,document.getElementById("guessInput").disabled=!0,document.getElementById("score").innerText=I;const t=document.querySelector("#resultTable tbody");t.innerHTML="",e.top10.forEach((i,r)=>{var s;const o=document.createElement("tr");if(o.innerHTML=`<td>${r+1}. ${i.name}</td><td>${i.distance.toFixed(4)}</td>`,t.appendChild(o),r<3&&d[i.name]){const c=[9,7,5][r];d[i.name].setStyle({fillColor:"lime",radius:c}),(s=d[i.name].getElement())==null||s.classList.add("blink")}}),document.getElementById("resultMessage").innerHTML=`<div style="font-size: 0.8em;"><em>Your Guess:</em> ${e.rank}. ${e.guess} (${e.score} points!) ${((n=e.distance)==null?void 0:n.toFixed(4))??"?"}</div>`,document.getElementById("resultBox").style.display="block"}function K(){const e=document.getElementById("popSuggestions");e.innerHTML="",w.forEach(t=>{const n=document.createElement("option");n.value=t,e.appendChild(n)})}const X={European:"blue",SSA:"darkgreen",EASEA:"orange",Siberian:"cyan",American:"purple",SAO:"magenta",MENA:"brown",WACA:"red",default:"gray"};async function Q(){const e=document.getElementById("regionSelect").value;let t=[];if(e==="6"&&(t=Array.from(document.querySelectorAll("#customRegions input:checked")).map(n=>n.value),t.length===0)){alert("Please select at least one region.");return}try{const n=await F(e,t);Y(n,X),U(),k(),B(!0),Object.entries(n.mix_description).forEach(([i])=>{d[i]&&d[i].setStyle({fillColor:"gold",radius:9})})}catch(n){console.error("startNewRound failed:",n),alert("Failed to generate new round.")}}function v(e){try{const t=H(e);N(!0),B(!1),V(t,d)}catch(t){console.error("submitGuess failed:",t),alert("Error scoring your guess.")}}window.addEventListener("DOMContentLoaded",async()=>{var n,i,r,o;await O(),K(),x(),D();function e(){if(M()){alert("You already guessed this round!");return}const s=document.getElementById("guessInput").value.trim();s!==""&&v(s)}const t=document.getElementById("guessInput");t==null||t.addEventListener("keypress",s=>{s.key==="Enter"&&e()}),(n=document.getElementById("submitBtn"))==null||n.addEventListener("click",e),(i=document.getElementById("regionSelect"))==null||i.addEventListener("change",()=>{const s=document.getElementById("regionSelect").value;document.getElementById("customRegions").style.display=s==="6"?"block":"none"}),(r=document.querySelectorAll("#customRegions input"))==null||r.forEach(s=>{s.addEventListener("click",c=>c.stopPropagation())}),(o=document.getElementById("newRoundBtn"))==null||o.addEventListener("click",()=>{Q(),setTimeout(()=>{var s;(s=document.getElementById("guessInput"))==null||s.focus()},50)})});window.submitGuess=e=>{if(T()){if(M()){alert("You already guessed this round!");return}v(e)}};
